name: lean-ci

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build-and-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Lake/LEAN
        uses: actions/cache@v4
        with:
          path: |
            ~/.elan
            .lake
            lake-packages
          key: ${{ runner.os }}-lean-${{ hashFiles('lean-toolchain') }}-${{ hashFiles('lakefile.lean', 'lake-manifest.json') }}
          restore-keys: |
            ${{ runner.os }}-lean-

      - name: Install Lean (elan)
        run: |
          bash Scripts/setup_lean.sh
        shell: bash

      - name: Build (lake)
        run: |
          bash Scripts/build_lean_proofs.sh
        shell: bash

      - name: Generate Proof Certificates
        run: |
          python3 Scripts/generate_proof_certificates.py
        shell: bash

      - name: Verify Proof Certificates
        run: |
          python3 Scripts/verify_proof_certificates.py
        shell: bash

      - name: Upload Proof Certificates
        uses: actions/upload-artifact@v4
        with:
          name: proof-certificates
          path: Results/Lean4_Certificates/
          retention-days: 90

      - name: Check no-sorry
        run: |
          bash Scripts/check_no_sorry.sh
        shell: bash

      - name: Lint
        run: |
          bash Scripts/lint.sh
        shell: bash
